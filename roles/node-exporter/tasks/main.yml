---
- name: create Prometheus group
  become: true
  group:
    name: "{{ prometheus_group }}"
    state: present

- name: create Prometheus user
  become: true
  user:
    name: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    createhome: no
    shell: /sbin/nologin
    comment: "Prometheus user"
    state: present

- name: create directories
  become: true
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "u=rwx,g=rx,o="
  with_items:
    - "{{ prometheus_install_path }}"
    - "{{ prometheus_log_path }}"
    - "{{ prometheus_pid_path }}"
    - "{{ prometheus_db_path }}"

- name: set tarball download url
  set_fact:
    node_exporter_tarball_url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"

- name: set daemon directory
  set_fact:
    node_exporter_daemon_dir: "{{ prometheus_install_path }}/node_exporter-{{ node_exporter_version }}.linux-amd64"

- name: download and untar node_exporter tarball
  become: true
  become_user: "{{ prometheus_user }}"
  unarchive:
    src: "{{ node_exporter_tarball_url }}"
    dest: "{{ prometheus_install_path }}"
    copy: no

- name: set node_exporter variables
  become: true
  copy: src="../files/etc-default-node_exporter"  dest=/etc/default/node_exporter
  register: node_exporter_config

- debug: var=node_exporter_config
  notify: reload node_exporter
  when: node_exporter_config.changed

- name: copy systemd config to server
  become: true
  template:
    src: "../templates/node_exporter.service.j2"
    dest: "/lib/systemd/system/node_exporter.service"

- name: set INIT status and start
  service:
    name: node_exporter
    enabled: yes
    state: started
