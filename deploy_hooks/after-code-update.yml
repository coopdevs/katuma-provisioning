---
- name: Execute bundle install
  bundler:
    state: present
    deployment_mode: yes
    executable: "{{ ansible_env.HOME }}/.rbenv/shims/bundle"
    gemfile: "{{ ansistrano_release_path.stdout }}/Gemfile"

- name: Create symlink to application.yml
  file:
    src: "{{ ansistrano_shared_path }}/config/application.yml"
    dest: "{{ ansistrano_release_path.stdout }}/config/application.yml"
    state: link
    owner: "{{ unicorn_user }}"

- name: Precompile assets
  command: "{{ bundle_exec }} exec rake assets:precompile"
  args:
    chdir: "{{ ansistrano_release_path.stdout }}"
  vars:
    bundle_exec: "{{ ansible_env.HOME }}/.rbenv/shims/bundle"
  environment:
    RAILS_ENV: "{{ rails_env }}"

- name: Restart katuma_reports_unicorn
  service:
    name: katuma_reports_unicorn
    state: restarted
